include ../partials/navbar

title My Orders

style.
  body {
    font-family: 'Roboto', sans-serif;
    background-color: #081c15;
    color: #e0e0e0;
    line-height: 1.6;
  }
  .container {
    max-width: 90vw;
    margin: 40px auto;
    padding: 0 20px;
  }
  .page-title {
    font-size: 2rem;
    color: #ffffff;
    margin-bottom: 30px;
    text-align: center;
  }
  .account-layout {
    display: flex;
    gap: 30px;
  }
  .account-menu {
    flex: 0 0 250px;
    background: #0f2a20;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    padding: 20px;
  }
  .account-menu ul {
    list-style: none;
    padding: 0;
  }
  .account-menu li {
    margin-bottom: 10px;
  }
  .account-menu a {
    display: block;
    padding: 10px 15px;
    color: #b8c9c5;
    text-decoration: none;
    border-radius: 5px;
    transition: background-color 0.3s ease;
  }
  .account-menu a:hover, .account-menu a.active {
    background-color: #1a4734;
    color: #ffffff;
  }
  .main-content {
    flex: 1;
    background: #0f2a20;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    padding: 30px;
    height:64vh;
  }
  .order-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 10px;
  }
  .order-table th, .order-table td {
    padding: 15px;
    text-align: left;
    background-color: #1a4734;
  }
  .order-table th {
    background-color: #143c2b;
    font-weight: 600;
    color: #ffffff;
  }
  .order-table tr {
    transition: all 0.3s ease;
  }
  .order-table tr:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  }
  .order-table tr td:first-child, .order-table tr th:first-child {
    border-top-left-radius: 8px;
    border-bottom-left-radius: 8px;
  }
  .order-table tr td:last-child, .order-table tr th:last-child {
    border-top-right-radius: 8px;
    border-bottom-right-radius: 8px;
  }
  .order-details-btn {
    background-color: #2d6a4f;
    color: white;
    padding: 8px 15px;
    border-radius: 5px;
    text-decoration: none;
    transition: background-color 0.3s ease;
  }
  .order-details-btn:hover {
    background-color: #40916c;
  }
  .order-empty {
    text-align: center;
    padding: 50px 0;
  }
  .no-order {
    font-size: 1.5rem;
    color: #95d5b2;
    margin-bottom: 20px;
  }
  .shop-button {
    display: inline-block;
    background-color: #40916c;
    color: white;
    padding: 12px 25px;
    border-radius: 5px;
    text-decoration: none;
    transition: background-color 0.3s ease;
  }
  .shop-button:hover {
    background-color: #52b788;
  }
    .pagination {
      margin-top: 20px;
      text-align: center;
    }

    .pagination a {
      display: inline-block;
      padding: 8px 16px;
      text-decoration: none;
      color: #000;
      background-color: #f1f1f1;
      border-radius: 5px;
      margin: 0 5px;
    }

    .pagination a:hover {
      background-color: #ddd;
    }

    .pagination span {
      display: inline-block;
      padding: 8px 16px;
    }

link(rel='stylesheet', href='https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap')
link(rel='stylesheet', href='../../stylesheet/navbar.css')

.container
  h1.page-title My Orders

  .account-layout
    .account-menu
      ul
        li: a(href='/user/profile') My Account
        li: a(href='/user/wishlist') My Wishlist
        li: a(href='/user/address/new') Address Book
        li: a(href='/user/order', class='active') My Orders
        li: a(href='/user/wallet') My Wallet

    .main-content
      if orders.length > 0
        table.order-table.table-sortable
          thead
            tr
              th Order ID
              th Order Date
              th Product(s)
              th Total
              th Payment Method
              th Status
              th Actions
          tbody
            each order in orders
              tr
                td= order._id
                td#createdDate(data-orderdate=order.created_at)= moment(order.created_at).format('MM/DD/YYYY')
                td
                  if order.items.length < 2
                    = order.items[0].name
                  else
                    | #{order.items[0].name}, #{order.items[1].name} 
                    - let len = order.items.length - 2
                    | and #{len} more..
                td $#{order.totalAmount.toFixed(2)}
                td= order.payment_method
                td= order.returnRequest.status ? `Return ${order.returnRequest.status}` : order.status
                td 
                  a.order-details-btn.d-flex(href=`/user/order/${order._id}`) View Details

        .pagination
          if currentPage > 1
            a.pagination-link(href=`/user/order?page=${currentPage - 1}`) Previous
          span Page #{currentPage} of #{totalPages}
          if currentPage < totalPages
            a.pagination-link(href=`/user/order?page=${currentPage + 1}`) Next
      else
        .order-empty
          p.no-order You haven't ordered any items yet!
          a.shop-button(href="/products") Shop Now

script(src="../../script/user/validateAddress.js")
script(src="../../script/user/sortTable.js")
script.
  document.addEventListener('DOMContentLoaded', function() {
    const currentUrl = window.location.pathname;
    document.querySelectorAll('.account-menu a').forEach(link => {
      if (link.getAttribute('href') === currentUrl) {
        link.classList.add('active');
      }
    });

    document.querySelectorAll('#createdDate').forEach(element => {
      const createdDate = element.dataset.orderdate;
      const date = new Date(createdDate);
      const formattedDate = date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });
      element.textContent = formattedDate;
    });


    const transactionTable = document.querySelector('.order-table.table-sortable');
    
    function attachPaginationListeners() {
      const paginationLinks = document.querySelectorAll('.pagination-link');
      paginationLinks.forEach(link => {
        link.addEventListener('click', handlePaginationClick);
      });
    }

    function handlePaginationClick(e) {
      e.preventDefault();
      const url = this.getAttribute('href');
      
      fetch(url)
        .then(response => response.text())
        .then(html => {
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const newTransactions = doc.querySelector('.order-table.table-sortable');
          const newPagination = doc.querySelector('.pagination');
          
          if (newTransactions) {
            transactionTable.innerHTML = newTransactions.innerHTML;
          } else {
            transactionTable.innerHTML = '<tr><td colspan="4">No transactions on this page.</td></tr>';
          }
          
          // Check if pagination container exists before updating
          const paginationContainer = document.querySelector('.pagination');
          if (paginationContainer && newPagination) {
            paginationContainer.outerHTML = newPagination.outerHTML;
          } else if (newPagination) {
            // If pagination container doesn't exist, but new pagination does, append it
            transactionTable.parentNode.insertAdjacentHTML('beforeend', newPagination.outerHTML);
          }
          
          // Update the URL without reloading the page
          history.pushState(null, '', url);
          
          // Reattach event listeners to new pagination links
          attachPaginationListeners();
        });
    }

    // Initial attachment of event listeners
    attachPaginationListeners();
  });
